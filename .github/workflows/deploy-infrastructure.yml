name: 'Deploy Infrastructure (Multi-Region)'

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'terraform/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy

permissions:
  contents: read

env:
  TF_VERSION: '1.5.0'
  WORKING_DIRECTORY: './terraform'
  # Environment Logic
  TF_ENV: ${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}
  
  # Credentials
  ARM_CLIENT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
  ARM_CLIENT_SECRET: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}
  ARM_SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}
  ARM_TENANT_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
  ARM_USE_OIDC: false
  
  # Inject Secrets into Terraform Variables
  TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
  TF_VAR_qdrant_api_key: ${{ secrets.QDRANT_API_KEY }}
  
  # Inject Config from GitHub Variables
  TF_VAR_azure_openai_api_version: ${{ vars.AZURE_OPENAI_API_VERSION }}
  TF_VAR_azure_openai_deployment: ${{ vars.AZURE_OPENAI_DEPLOYMENT }}
  TF_VAR_azure_openai_embedding_deployment: ${{ vars.AZURE_OPENAI_EMBEDDING_DEPLOYMENT }}
  TF_VAR_azure_openai_embedding_model: ${{ vars.AZURE_OPENAI_EMBEDDING_MODEL }}
  TF_VAR_openai_base_url: ${{ vars.OPENAI_BASE_URL }}
  TF_VAR_qdrant_url: ${{ vars.QDRANT_URL }}
  TF_VAR_qdrant_collection_name: ${{ vars.QDRANT_COLLECTION_NAME }}

jobs:
  terraform:
    name: 'Terraform'
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    
    defaults:
      run:
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
    
    outputs:
      acr_login_server: ${{ steps.terraform_outputs.outputs.acr_login_server }}
      acr_name: ${{ steps.terraform_outputs.outputs.acr_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init
      run: |
        STORAGE_KEY=$(az storage account keys list \
          --resource-group helpingtoolswithinframanage \
          --account-name infraandautomationstore \
          --query '[0].value' \
          --output tsv)
        
        terraform init \
          -backend-config="subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
          -backend-config="resource_group_name=helpingtoolswithinframanage" \
          -backend-config="storage_account_name=infraandautomationstore" \
          -backend-config="container_name=terraformstatestore" \
          -backend-config="key=newsrag-api-${{ env.TF_ENV }}.tfstate" \
          -backend-config="access_key=$STORAGE_KEY"

    - name: Terraform Plan
      if: github.event.inputs.action != 'destroy'
      run: |
        terraform plan \
          -var-file="environments/${{ env.TF_ENV }}.tfvars" \
          -out=tfplan

    - name: Terraform Apply
      if: github.event.inputs.action == 'apply' || github.event_name == 'push'
      run: |
        terraform apply -auto-approve tfplan
      
    - name: Terraform Destroy
      if: github.event.inputs.action == 'destroy'
      run: |
        terraform destroy -auto-approve \
          -var-file="environments/${{ env.TF_ENV }}.tfvars"

    - name: Get Outputs
      if: github.event.inputs.action != 'destroy'
      id: terraform_outputs
      run: |
        echo "acr_login_server=$(terraform output -raw acr_login_server)" >> $GITHUB_OUTPUT
        echo "acr_name=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
