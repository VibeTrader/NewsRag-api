# ğŸŒ NewsRag API - Multi-Region Infrastructure with Azure Front Door

This Terraform configuration creates a **production-ready multi-region deployment** of your NewsRag FastAPI application across 3 regions with Azure Front Door CDN, full monitoring, and alerting.

## ğŸ—ï¸ Infrastructure Overview

### ğŸŒ **Global Resources** (Shared)
| Resource | Name | Description |
|----------|------|-------------|
| **Resource Group** | `vibetrader-RAG-rg` | Existing resource group (reused) |
| **Log Analytics** | `logs-newsraag-shared-prod` | 30-day retention, PerGB2018 pricing |
| **Application Insights** | `insights-newsraag-shared-prod` | Unified monitoring across all regions |
| **Azure Front Door** | `fd-newsraag-prod` | **NEW** Global CDN with HTTPS, health probes, WAF (optional) |
| **Action Group** | `ag-newsraag-prod` | Email alerts to haripriyaveluchamy@aity.dev |

### ğŸ‡ºğŸ‡¸ **US Region** (East US)
| Resource | Name | Specs |
|----------|------|-------|
| **App Service Plan** | `plan-newsraag-us-prod` | Linux, Basic B1 (upgradable) |
| **Web App** | `newsraag-us-prod` | Python 3.12, FastAPI ready |
| **Auto-scaling** | `autoscale-newsraag-us-prod` | CPU/Memory based scaling |
| **URL** | `newsraag-us-prod.azurewebsites.net` | Direct regional access |

### ğŸ‡ªğŸ‡º **Europe Region** (North Europe)
| Resource | Name | Specs |
|----------|------|-------|
| **App Service Plan** | `plan-newsraag-eu-prod` | Linux, Basic B1 (upgradable) |
| **Web App** | `newsraag-eu-prod` | Python 3.12, FastAPI ready |
| **Auto-scaling** | `autoscale-newsraag-eu-prod` | CPU/Memory based scaling |
| **URL** | `newsraag-eu-prod.azurewebsites.net` | Direct regional access |

### ğŸ‡®ğŸ‡³ **India Region** (Central India)
| Resource | Name | Specs |
|----------|------|-------|
| **App Service Plan** | `plan-newsraag-in-prod` | Linux, Basic B1 (upgradable) |
| **Web App** | `newsraag-in-prod` | Python 3.12, FastAPI ready |
| **Auto-scaling** | `autoscale-newsraag-in-prod` | CPU/Memory based scaling |
| **URL** | `newsraag-in-prod.azurewebsites.net` | Direct regional access |

## ğŸš€ **Azure Front Door Features**
- âœ… **Global CDN** - Edge locations worldwide
- âœ… **Automatic HTTPS** - Managed SSL certificates
- âœ… **Intelligent Routing** - Latency + health-based
- âœ… **DDoS Protection** - Built-in security
- âœ… **WAF** - Web Application Firewall (Premium tier)
- âœ… **Health Probes** - Automatic failover
- âœ… **Caching** - Improved performance

## ğŸ”” **Comprehensive Monitoring** (15+ Alert Rules)

### **Performance Monitoring**
- **Response Time Alerts** (3): > 5 seconds per region
- **CPU Usage Alerts** (3): > 80% for 15 minutes per region
- **Memory Usage Alerts** (3): > 85% for 15 minutes per region

### **Reliability Monitoring**  
- **Error Rate Alerts** (3): > 10 HTTP 5xx errors in 5 minutes per region
- **Global Availability Alert** (1): < 90% uptime across all regions

### **Alert Destinations**
- **ğŸ“§ Email**: haripriyaveluchamy@aity.dev
- **ğŸ“± Slack**: Optional (add webhook URL in config)

## ğŸŒ **Traffic Routing Strategy**

```
ğŸŒ Global URL: newsraag-global-prod.trafficmanager.net
â”œâ”€â”€ ğŸ‡ºğŸ‡¸ Americas â†’ newsraag-us-prod.azurewebsites.net
â”œâ”€â”€ ğŸ‡ªğŸ‡º Europe/MENA â†’ newsraag-eu-prod.azurewebsites.net
â””â”€â”€ ğŸ‡®ğŸ‡³ Asia-Pacific â†’ newsraag-in-prod.azurewebsites.net
```

### **Geographic Mappings**
- **ğŸ‡ºğŸ‡¸ US Region**: US, CA, MX, Central America
- **ğŸ‡ªğŸ‡º Europe Region**: Europe, Jordan, UAE, Saudi Arabia, Egypt, etc.
- **ğŸ‡®ğŸ‡³ India Region**: India, Pakistan, Bangladesh, Southeast Asia

## ğŸ’° **Complete Cost Breakdown**

| Component | Quantity | Unit Cost | Monthly Total |
|-----------|----------|-----------|---------------|
| **App Service Plans (B1)** | 3 regions | $13.14 each | $39.42 |
| **Traffic Manager** | 1 profile | ~$0.54/million queries | $1-3 |
| **Application Insights** | 1 instance | ~$2.30/GB ingested | $10-20 |
| **Log Analytics** | 1 workspace | ~$2.30/GB ingested | $5-10 |
| **Alert Rules** | 15+ rules | Free tier | $0 |
| **Resource Groups** | 4 groups | Free | $0 |
| **Health Checks** | Included | Free | $0 |
| **ğŸ“Š TOTAL ESTIMATED** |  |  | **$55-75/month** |

## âš™ï¸ **Pre-configured App Settings**

Each App Service gets these environment variables automatically:

### **Global Settings** (All Regions)
```bash
PYTHON_VERSION=3.12
ENVIRONMENT=production
WEBSITES_PORT=8000
API_HOST=0.0.0.0
API_PORT=8000
HEALTH_CHECK_ENABLED=true
```

### **Region-Specific Settings**
```bash
# US Region
DEPLOYMENT_REGION=us
AZURE_REGION=East US

# Europe Region  
DEPLOYMENT_REGION=eu
AZURE_REGION=West Europe

# India Region
DEPLOYMENT_REGION=in
AZURE_REGION=South India
```

### **Application Insights** (Auto-configured)
```bash
APPINSIGHTS_INSTRUMENTATIONKEY=<auto-generated>
APPLICATIONINSIGHTS_CONNECTION_STRING=<auto-generated>
```

## ğŸš€ **Deployment Instructions**

### **Prerequisites**
```bash
# 1. Azure CLI installed and logged in
az login
az account set --subscription "your-subscription-id"

# 2. Terraform installed (>= 1.0)
terraform --version
```

### **Deploy Infrastructure**
```bash
# Navigate to terraform directory
cd terraform/

# Initialize Terraform
terraform init

# Review the plan
terraform plan -var-file="environments/prod.tfvars"

# Deploy infrastructure
terraform apply -var-file="environments/prod.tfvars"
```

### **What Gets Created**
1. **4 Resource Groups** (1 global + 3 regional)
2. **1 Log Analytics Workspace** (30-day retention)
3. **1 Application Insights** (web application type)
4. **3 App Service Plans** (Basic B1, Linux)
5. **3 Linux Web Apps** (Python 3.12, FastAPI ready)
6. **3 Auto-scaling Rules** (CPU and memory based)
7. **1 Traffic Manager** (geographic routing)
8. **3 Traffic Manager Endpoints** (one per region)
9. **1 Action Group** (email notifications)
10. **15+ Metric Alerts** (comprehensive monitoring)

## ğŸ“Š **After Deployment - You Get**

### **ğŸŒ Global Access**
- **Primary URL**: `https://newsraag-global-prod.trafficmanager.net`
- **Health Check**: `https://newsraag-global-prod.trafficmanager.net/health`

### **ğŸ”— Regional Direct Access**
- **ğŸ‡ºğŸ‡¸ US**: `https://newsraag-us-prod.azurewebsites.net`
- **ğŸ‡ªğŸ‡º Europe**: `https://newsraag-eu-prod.azurewebsites.net` 
- **ğŸ‡®ğŸ‡³ India**: `https://newsraag-in-prod.azurewebsites.net`

### **ğŸ“Š Monitoring Dashboard**
- **Azure Portal**: Application Insights â†’ `insights-newsraag-prod`
- **Built-in Views**: Performance, Failures, Availability, Users
- **Custom Queries**: Multi-region analysis with Kusto

## ğŸ”§ **Configuration Customization**

### **Add Your App Settings**
Edit `terraform/environments/prod.tfvars` and add:

```hcl
app_settings = {
  # Existing settings...
  
  # Your Azure OpenAI settings
  OPENAI_BASE_URL = "https://your-endpoint.openai.azure.com"
  AZURE_OPENAI_API_VERSION = "2024-02-01"
  AZURE_OPENAI_DEPLOYMENT = "your-deployment-name"
  
  # Your Qdrant settings
  QDRANT_URL = "your-qdrant-url"
  QDRANT_COLLECTION_NAME = "news_articles"
  
  # Add any other environment variables
  YOUR_CUSTOM_SETTING = "your-value"
}
```

### **Scale Up When Ready**
```hcl
# Change in prod.tfvars for production load
app_service_plan_sku = "S2"  # Standard tier
app_service_plan_tier = "Standard"
min_instances = 2
max_instances = 10
```

### **Add Slack Alerts**
```hcl
# Add your Slack webhook URL
slack_webhook_url = "https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"
```

## ğŸ¥ **Health Check Requirements**

Your FastAPI app must have a health endpoint at `/health` that returns HTTP 200:

```python
@app.get("/health")
def health_check():
    return {
        "status": "healthy",
        "region": os.environ.get('DEPLOYMENT_REGION', 'unknown'),
        "timestamp": datetime.utcnow().isoformat()
    }
```

## ğŸ”„ **Next Steps After Infrastructure Deployment**

1. **âœ… Verify URLs**: Test all 4 URLs (global + 3 regional)
2. **ğŸš€ Deploy Your App**: Use GitHub Actions or Azure deployment
3. **ğŸ“Š Monitor Performance**: Check Application Insights dashboards
4. **ğŸ”” Test Alerts**: Verify email notifications work
5. **ğŸ“ˆ Scale as Needed**: Upgrade tiers based on usage
6. **ğŸŒ Add Custom Domain**: Configure your own domain name
7. **ğŸ”’ Add SSL Certificate**: Set up custom SSL certs

## ğŸ¯ **This Creates a Production-Ready**

- âœ… **Globally distributed** FastAPI application
- âœ… **Auto-scaling** based on CPU and memory
- âœ… **Health check monitoring** with automatic failover
- âœ… **Comprehensive alerting** via email (and optional Slack)
- âœ… **Cost-optimized** Basic tier for starting (easily scalable)
- âœ… **Zero-dependency** setup (all resources created fresh)

**ğŸš€ Ready to go global with your NewsRag API!**
